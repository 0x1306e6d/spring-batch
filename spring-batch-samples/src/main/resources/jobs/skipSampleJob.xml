<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.0.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<job id="skipJob" incrementer="incrementer" xmlns="http://www.springframework.org/schema/batch">
		<step id="step1" parent="baseStep">
			<tasklet>
				<chunk reader="fileItemReader" processor="tradeProcessor" writer="tradeWriter" 
		               commit-interval="3" skip-limit="10">
					<skippable-exception-classes>
						org.springframework.batch.item.file.FlatFileParseException
						org.springframework.batch.item.WriteFailedException
					</skippable-exception-classes>
				</chunk>
			</tasklet>

			<next on="*" to="step2" />
			<next on="COMPLETED WITH SKIPS" to="errorPrint1" />
			<fail on="FAILED" exit-code="FAILED"/>
		</step>

		<step id="errorPrint1" next="step2">
			<tasklet ref="errorLogTasklet"/>
		</step>

		<step id="step2" parent="secondPass" next="skipCheckingDecision"/>

		<decision id="skipCheckingDecision" decider="skipCheckingDecider">
			<end on="*"/>
			<next on="COMPLETED WITH SKIPS" to="errorPrint2" />
			<fail on="FAILED" exit-code="FAILED"/>
		</decision>
		
		<step id="errorPrint2">
			<tasklet ref="errorLogTasklet"/>
		</step>
	</job>

	<step id="secondPass" parent="t2" xmlns="http://www.springframework.org/schema/batch">
		<tasklet>
			<chunk writer="itemTrackingWriter">
				<skippable-exception-classes merge="true">
					org.springframework.batch.item.validator.ValidationException
				</skippable-exception-classes>
			</chunk>
		</tasklet>
	</step>

	<step id="t2" parent="t3" abstract="true" xmlns="http://www.springframework.org/schema/batch"/>

	<step id="t3" parent="baseStep" abstract="true" xmlns="http://www.springframework.org/schema/batch">
		<tasklet>
			<chunk reader="tradeSqlItemReader" processor="tradeProcessor" writer="dummyWriter" 
	               commit-interval="2" skip-limit="10">
				<skippable-exception-classes>
					java.lang.RuntimeException
				</skippable-exception-classes>
			</chunk>
		</tasklet>
	</step>

	<step id="baseStep" abstract="true" xmlns="http://www.springframework.org/schema/batch">
		<tasklet>
			<listeners>
				<listener class="org.springframework.batch.sample.common.SkipCheckingListener"/>
				<listener ref="promotionListener"/>
			</listeners>
		</tasklet>
	</step>
	
	<bean id="dummyWriter" class="org.springframework.batch.sample.support.DummyItemWriter"/>

	<bean id="promotionListener" class="org.springframework.batch.core.listener.ExecutionContextPromotionListener" scope="step">
		<property name="keys" value="stepName"/>
	</bean>
	
	<bean id="fileItemReader" class="org.springframework.batch.item.file.FlatFileItemReader" scope="step">
		<property name="resource" value="classpath:/data/skipJob/input/input#{jobParameters[run.id]}.txt" />
		<property name="lineMapper">
			<bean class="org.springframework.batch.item.file.mapping.DefaultLineMapper">
				<property name="lineTokenizer">
					<bean class="org.springframework.batch.item.file.transform.DelimitedLineTokenizer">
						<property name="names" value="ISIN, Quantity, Price, Customer" />
					</bean>
				</property>
				<property name="fieldSetMapper">
					<bean class="org.springframework.batch.sample.domain.trade.internal.TradeFieldSetMapper" />
				</property>
			</bean>
		</property>
	</bean>

	<bean id="tradeProcessor" class="org.springframework.batch.sample.domain.trade.internal.TradeProcessor"/>
	
	<bean id="tradeSqlItemReader" class="org.springframework.batch.item.database.JdbcCursorItemReader">
		<property name="dataSource" ref="dataSource" />
		<property name="sql" value="SELECT isin, quantity, price, customer from TRADE" />
		<property name="rowMapper">
			<bean class="org.springframework.batch.sample.domain.trade.internal.TradeRowMapper" />
		</property>
	</bean>

	<bean id="customerReportItemWriter" class="org.springframework.batch.sample.domain.trade.internal.FlatFileCustomerCreditDao">
		<property name="itemWriter">
			<bean id="customerFlatFileOutputSource" class="org.springframework.batch.item.file.FlatFileItemWriter">
				<property name="resource" value="target/test-outputs/20070122.testStream.CustomerReportStep.TEMP.txt" />
				<property name="lineAggregator">
					<bean class="org.springframework.batch.item.file.transform.PassThroughLineAggregator" />
				</property>
			</bean>
		</property>
	</bean>

	<bean id="errorLogTasklet" class="org.springframework.batch.sample.common.ErrorLogTasklet">
		<property name="dataSource" ref="dataSource"/>
	</bean>

	<bean id="skipCheckingDecider" class="org.springframework.batch.sample.common.SkipCheckingDecider"/>
	
	<bean id="incrementer" class="org.springframework.batch.sample.common.InfiniteLoopIncrementer"/>

</beans>
