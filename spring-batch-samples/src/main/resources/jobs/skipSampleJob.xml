<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
       		http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       		http://www.springframework.org/schema/batch
       		http://www.springframework.org/schema/batch/spring-batch-2.0.xsd
       		http://www.springframework.org/schema/aop
 			http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">

	<batch:job id="skipJob" incrementer="incrementer">
		<batch:step name="step1">
			<batch:end on="FAILED" status="FAILED"/>
			<batch:next on="COMPLETED WITH SKIPS" to="errorPrint1" />
			<batch:next on="*" to="step2" />
		</batch:step>

		<batch:step name="errorPrint1" next="step2"/>

		<batch:step name="step2" next="skipCheckingDecision"/>

		<batch:decision id="skipCheckingDecision" decider="skipCheckingDecider">
			<batch:next on="COMPLETED WITH SKIPS" to="errorPrint2" />
			<batch:end on="*"/>
		</batch:decision>
		
		<batch:step name="errorPrint2" />
	</batch:job>

	<bean id="step1" parent="skipLimitStep">
		<property name="skipLimit" value="1" />
		<property name="itemReader" ref="fileItemReader" />
		<property name="itemProcessor">
			<bean class="org.springframework.batch.sample.domain.trade.internal.TradeProcessor"/>
		</property>
		<property name="itemWriter">
			<bean class="org.springframework.batch.sample.domain.trade.internal.TradeWriter" p:dao-ref="tradeDao" />
		</property>
		<property name="listeners">
			<list>
				<bean class="org.springframework.batch.sample.common.SkipCheckingListener"/>
			</list>
		</property>
	</bean>

	<bean id="step2" parent="skipLimitStep">
		<property name="commitInterval" value="2" />
		<property name="skipLimit" value="1" />
		<property name="skippableExceptionClasses">
            <list>
                <value>org.springframework.batch.item.validator.ValidationException</value>
                <value>java.lang.RuntimeException</value>
            </list>
		</property>
		<property name="itemReader" ref="tradeSqlItemReader" />
		<property name="itemProcessor">
			<bean class="org.springframework.batch.sample.domain.trade.internal.TradeProcessor"/>
		</property>
		<property name="itemWriter" ref="itemTrackingWriter" />
		<property name="listeners">
			<list>
				<bean class="org.springframework.batch.sample.common.SkipCheckingListener"/>
			</list>
		</property>
	</bean>

	<bean id="fileItemReader" class="org.springframework.batch.item.file.FlatFileItemReader" scope="step">
		<property name="resource" value="classpath:/data/skipJob/input/input#{jobParameters[run.id]}.txt" />
		<property name="lineMapper">
			<bean class="org.springframework.batch.item.file.mapping.DefaultLineMapper">
				<property name="lineTokenizer">
					<bean class="org.springframework.batch.item.file.transform.DelimitedLineTokenizer">
						<property name="names" value="ISIN, Quantity, Price, Customer" />
					</bean>
				</property>
				<property name="fieldSetMapper">
					<bean class="org.springframework.batch.sample.domain.trade.internal.TradeFieldSetMapper" />
				</property>
			</bean>
		</property>
	</bean>

	<bean class="org.springframework.batch.core.scope.StepScope" />

	<bean id="tradeDao" class="org.springframework.batch.sample.domain.trade.internal.JdbcTradeDao"
		  p:dataSource-ref="dataSource">
		<property name="incrementer">
			<bean parent="incrementerParent">
				<property name="incrementerName" value="TRADE_SEQ" />
			</bean>
		</property>
	</bean>

	<bean id="tradeSqlItemReader" class="org.springframework.batch.item.database.JdbcCursorItemReader">
		<property name="dataSource" ref="dataSource" />
		<property name="sql" value="SELECT isin, quantity, price, customer from TRADE" />
		<property name="mapper">
			<bean class="org.springframework.batch.sample.domain.trade.internal.TradeRowMapper" />
		</property>
	</bean>

	<bean id="customerReportItemWriter"
		  class="org.springframework.batch.sample.domain.trade.internal.FlatFileCustomerCreditDao">
		<property name="itemWriter">
			<bean id="customerFlatFileOutputSource"
				  class="org.springframework.batch.item.file.FlatFileItemWriter">
				<property name="resource" value="target/test-outputs/20070122.testStream.CustomerReportStep.TEMP.txt" />
				<property name="lineAggregator">
					<bean class="org.springframework.batch.item.file.transform.PassThroughLineAggregator" />
				</property>
			</bean>
		</property>
	</bean>

	<bean id="errorPrint" parent="taskletStep">
		<property name="tasklet">
			<bean class="org.springframework.batch.sample.common.ErrorLogTasklet">
				<property name="dataSource" ref="dataSource"/>
			</bean>
		</property>
	</bean>
	<bean id="errorPrint1" parent="errorPrint"/>
	<bean id="errorPrint2" parent="errorPrint"/>

	<bean id="skipCheckingDecider" class="org.springframework.batch.sample.common.SkipCheckingDecider"/>
	
	<bean id="incrementer" class="org.springframework.batch.sample.common.InfiniteLoopIncrementer"/>
</beans>